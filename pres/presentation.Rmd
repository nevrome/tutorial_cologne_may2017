---
title: "recexcavAAR and far beyond..."
subtitle: "Anregungen rund um R, Data Science und Archäologie"
author: "Clemens Schmid"
date: "17. Mai 2017"
fontsize: 9pt
header-includes:
   - \usepackage{menukeys}
   - \usepackage{fourier}
   - \usepackage{fontawesome}
   - \newcommand{\columnsbegin}{\begin{columns}}
   - \newcommand{\columnsend}{\end{columns}}
output:
  beamer_presentation:
    theme: "metropolis"
fig_caption: yes
---

## Tutorial

\columnsbegin
\column{0.4\textwidth}

\begin{figure}[h]
\centering
\includegraphics[scale=0.25]{images/tree.png}
\caption{Inhaltsbaum}
\end{figure}

\column{0.5\textwidth}

\begin{itemize}
  \item R Pakete \textcolor{black}{\faListOl}\ \textcolor{red}{\faListOl}
  \item 3D plots in R
  \item Reports
  \item recexcavAAR
  \item tidyverse
\end{itemize}

\begin{quote}
A step to help you slow down - put your fork/spoon down between bites and take a sip of water before picking them up for the next bite. 

-- reddit user \textbf{angelforhirex} im Thread "I want to learn how to eat smaller portions"
\end{quote}

\columnsend



# R Pakete

## R Pakete

\underline{R Development Core Team -- Writing R Extensions}  
https://cran.r-project.org/doc/manuals/r-release/R-exts.pdf

\underline{Hadley Wickham -- \textbf{R packages}}  
http://r-pkgs.had.co.nz/

\rule{\textwidth}{1pt}

> Packages are the fundamental units of reproducible R code. They include reusable **R functions**, the **documentation** that describes how to use them, and **sample data**.
>
> -- Hadley Wickham

## R Pakete

\columnsbegin
\column{0.5\textwidth}

\textbf{Windows ohne Rtools}

\textcolor{black}{\textbf{1.}} RStudio: Ein neues Projekt \emph{\textasciitilde/expack} anlegen

\textcolor{black}{\textbf{2.}} Windows binaries für Paket expack herunterladen

https://github.com/nevrome/tutorial_cologne_may2017/tree/master/expack

\textcolor{black}{\textbf{3.}} RStudio: expack installieren (Packages > Install > Package Archive File)

\textcolor{black}{\textbf{4.}} Paket laden

```{r, eval=FALSE}
library(expack)
```

\column{0.5\textwidth}

\textbf{Linux oder Windows mit Rtools}

\textcolor{red}{\textbf{1.}} Paket anlegen

```{r, eval=FALSE}
devtools::create("~/expack")
```

\textcolor{red}{\textbf{2.}} RStudio: In das entstandene Projekt wechseln

\textcolor{red}{\textbf{3.}} Beispieldaten schaufeln 

https://github.com/nevrome/tutorial_cologne_may2017/tree/master/data

\faFolderOpenO \ \emph{\textasciitilde/expack/data/}

\textcolor{red}{\textbf{4.}} Paket bauen, installieren und laden: \newline \keys{\ctrl + \shift + B}

```{r, eval=FALSE}
#devtools::build()
#devtools::install()
library(expack)
```

\columnsend

## R Pakete

\textcolor{black}{\textbf{5.}} Fleischbeschau!

```{r, eval=FALSE}
help(package="expack")
```

\textcolor{black}{\textbf{6.}} Beispieldaten ansehen

```{r, eval=FALSE}
trench

```

\textcolor{black}{\textbf{7.}} On a completely different note... Pakete installieren

```{r, eval=FALSE}
install.packages(c("rgl", "recexcavAAR", "magrittr", "tidyverse"))
```



# 3D plots in R

## 3D plots in R

\underline{JavaScript APIs: \textbf{plotly} \& \textbf{rthreejs}}  
https://plot.ly/r/#3d-charts \newline    https://github.com/bwlewis/rthreejs

\underline{OpenGL API: \textbf{rgl}}  
https://cran.r-project.org/web/packages/rgl/vignettes/rgl.html

\rule{\textwidth}{1pt}

Für echte 3D plots gibt es in R im Augenblick zwei Optionen:  
APIs zu JavaScript Rendering Bibliotheken und GPU APIs.

Nur **rgl** besitzt einen **großen Funktionsumfang**, ist wegen der direkten GPU Nutzung über OpenGL lokal **performant** und kann gleichermaßen automatisch embedded JavaScript für **Web-Anwendungen** generieren. 

\rule{\textwidth}{1pt}

\underline{JavaScript Visualisierung mit R}  
http://www.htmlwidgets.org/

## 3D plots in R

\textcolor{black}{\textbf{1.}} neues R-Skript \emph{\textasciitilde/expack/R/dreiD.R} anlegen

\textcolor{black}{\textbf{2.}} coole Funktion schreiben

```{r, eval=FALSE, size = "tiny"}
coolplot <- function(points_df, type = "p", ...){
  rgl::plot3d(
    points_df[, 1], points_df[, 2], points_df[, 3],
    type = type,
    xlab = "x", ylab = "y", zlab = "z",
    ...
  )
}
```

\textcolor{red}{\textbf{3.}} Namen der Funktion `coolplot` exportieren, indem man \emph{\textasciitilde/expack/NAMESPACE} editiert

```{}
export(coolplot)
```

## 3D plots in R

\textcolor{red}{\textbf{4.}} Paket \textbf{rgl} als Voraussetzung des Pakets definieren, indem man \emph{~/expack/DESCRIPTION} editiert

```{}
...
Description: What the package does (one paragraph).
Imports:
  rgl (>= 0.98.1)
Depends: R (>= 3.3.3)
...
```

\textcolor{red}{\textbf{5.}} Paket neu bauen: \keys{\ctrl + \shift + B}

\textcolor{black}{\textbf{6.}} Ausprobieren!

```{r, eval=FALSE}
coolplot(trench, type = "l")
coolplot(sherds, type = "p", add = TRUE)
```

## 3D plots in R

\textcolor{black}{\textbf{7.}} noch eine coole Funktion schreiben

```{r, eval=FALSE}
coolpicture <- function(image, position) {
  rgl::show2d( { graphics::par(mar = rep(0, 4))
                 graphics::plot( 0:1, 0:1, type = "n", ann = FALSE,
                                 axes = FALSE, xaxs = "i", yaxs = "i" )
                 graphics::rasterImage(image, 0, 0, 1, 1)
                },
    x = position[, 1], y = position[, 2], z = position[, 3]
  )
}
```

\textcolor{red}{\textbf{8.}} Namen der neuen Funktion exportieren und Paket neu bauen (\keys{\ctrl + \shift + B})

```{}
export(coolpicture)
```

\textcolor{black}{\textbf{9.}} Ausprobieren!

```{r, eval=FALSE}
coolplot(trench, type = "l")
coolpicture(Nprofile, Nprofile_corners)
```



# Reports 

## Reports

\underline{\textbf{R Markdown}}  
http://rmarkdown.rstudio.com/

\underline{Markdown Cheatsheet}  
http://commonmark.org/help/

\rule{\textwidth}{1pt}


R Markdown ist ein Framework zur Erstellung von **daten- und analyseorientierter Texte, Websites und Präsentationen**

- Sehr einfache Auszeichnungssprache Markdown
- Verarbeitung von **R, Python und SQL-Code**
- Integration von **Textverarbeitungswerkzeugen** (z.B. Referenzmanagement)
- Output über vorimplementierte Parsingworkflows: \newline \textbf{PDF, HTML, Word-Dokumente, etc...}

## Reports

\columnsbegin
\column{0.5\textwidth}

\textcolor{black}{\textbf{1.}} RStudio: Ein neues RMarkdown Dokument anlegen

File > New File > R Markdown > Document > HTML

\column{0.5\textwidth}

\textcolor{red}{\textbf{1.}} Eine neue Vignette anlegen und das Paket dafür vorbereiten

```{r, eval=FALSE}
devtools::use_vignette("recex")
```

\columnsend

\textcolor{black}{\textbf{2.}} Dokument testweise rendern: \keys{\ctrl + \shift + K} 

```{r, eval=FALSE}
rmarkdown::render("~expack/.../recex.Rmd")
```

\textcolor{black}{\textbf{3.}} Inhalt abgesehen vom Header (zwischen `---`) löschen

\textcolor{black}{\textbf{4.}} Überschrift und Text anlegen (\danger\  Leerzeilen!)

```{}
# Space archaeology

The Kingdom of the Crystal Skull was a good movie.

> "RRRAARRWHHGWWR."
> -- Chewbacca in *The Empire Strikes Back*

![](https://goo.gl/XOF2ce)
```

## Reports

\textcolor{black}{\textbf{5.}} R code chunks anlegen: `` ```{r} `` ... `` ``` `` 

\textcolor{black}{\textbf{6.}} Chunks mit Leben füllen: Bibliotheken laden

`` ```{r} ``
```{r, eval=FALSE}
library(expack)
library(rgl)
library(recexcavAAR)
```
`` ``` `` 

\textcolor{black}{\textbf{7.}} 2D Plot (und anschließend rendern: \keys{\ctrl + \shift + K})

`` ```{r} ``
```{r, eval = FALSE}
plot(sherds$x, sherds$z)
```
`` ``` `` 

## Reports

\textcolor{black}{\textbf{8.}} 3D Plot (\keys{\ctrl + \shift + K})

`` ```{r, echo=FALSE, results="hide"} ``
```{r, eval=FALSE}
# avoid plotting in X11 window
open3d(useNULL = TRUE)
```
`` ``` `` 

`` ```{r} ``
```{r, eval=FALSE}
coolplot(trench, type = "l")
coolpicture(Nprofile, Nprofile_corners)
coolplot(sherds, type = "p", add = TRUE, col = "red", size = 10)
```
`` ``` `` 

`` ```{r, echo=FALSE} ``
```{r, eval=FALSE}
rglwidget()
```
`` ``` `` 



# recexcavAAR

## recexcavAAR

\underline{recexcavAAR auf Github -- Entwicklungsumgebung}  
https://github.com/ISAAKiel/recexcavAAR

\underline{recexcavAAR auf CRAN}  
https://CRAN.R-project.org/package=recexcavAAR

\rule{\textwidth}{1pt}

\begin{figure}[h]
\centering
\includegraphics[scale=0.6]{images/history.png}
\caption{Timeline recexcavAAR}
\end{figure}

## recexcavAAR

> ...
>
> Description: A toolset for 3D reconstruction and analysis of excavations. It provides methods to reconstruct natural and artificial surfaces based on field measurements. This allows to **spatially contextualize documented subunits and features**. Intended to be part of a 3D visualization workflow.
> 
> ...

**Vignettes** (Mai 2017)

- [\faExternalLink\  Semiautomatic spit attribution](https://isaakiel.github.io/recexcavAAR-vignette-1.html)
- [\faExternalLink\  Trench visualisation](https://isaakiel.github.io/recexcavAAR-vignette-2.html)
- [\faExternalLink\  Transforming coordinates](https://isaakiel.github.io/recexcavAAR-vignette-3.html)

**Meine Lieblingsfunktionen**

- `fillhexa`: Fills hexahedrons with a regular point raster (3D) 
- `posdeclist`: Multiple point position decision in relation to a set of stacked surfaces (3D)

## recexcavAAR

\textcolor{red}{\textbf{1.}} Paket \textbf{recexcavAAR} als Voraussetzung des Pakets definieren

```{}
Imports:
  rgl (>= 0.98.1),
Suggests:
  recexcavAAR (>= 0.3.0)
```

\textcolor{black}{\textbf{2.}} Kriging und Positionsbestimmung im Dokument hinzufügen

`` ```{r} ``
```{r, eval=FALSE}
surf <- recexcavAAR::kriglist(
  list(nivellement1, nivellement2), lags = 2
)
sherds_pos <- recexcavAAR::posdec(sherds[1:3], surf)
```
`` ``` ``

## recexcavAAR

\textcolor{black}{\textbf{3.}} 3D Plot (... und \keys{\ctrl + \shift + K})

`` ```{r} ``
```{r, eval=FALSE}
coolplot(trench, type = "l")
coolpicture(Nprofile, Nprofile_corners)
coolplot(
  sherds_pos, type = "p", add = TRUE, 
  col = sherds_pos$pos + 1, size = 10
)
coolplot(surf[[1]], type = "p", add = TRUE)
coolplot(surf[[2]], type = "p", add = TRUE)
```
`` ``` `` 

`` ```{r, echo=FALSE} ``
```{r, eval=FALSE}
rglwidget()
```
`` ``` `` 



# tidyverse

## tidyverse

\columnsbegin
\column{0.5\textwidth}

\underline{Hadley Wickham -- \textbf{R for Data Science}}  
http://r4ds.had.co.nz/

\column{0.5\textwidth}

\underline{Winston Chang -- \textbf{R Graphics Cookbook}}  
http://www.cookbook-r.com/Graphs/

\columnsend

\rule{\textwidth}{1pt}

Das tidyverse ist eine **Sammlung von auf einander angepassten Paketen** für **Datenverarbeitung** und **Modellierung**, die zum **digitalen Standardwerkzeug** eines Archäologen gehören sollte. 

|||
|---|---|
|**ggplot2:** | Daten visualisieren (plot 2.0) |
|**tibble:**  | Daten verwalten (data.frame 2.0 **?**) |
|**tidyr:**   | Datenlayout bereinigen |
|**readr:**   | Daten einlesen (read.table 2.0 **?**) |
|**dplyr:**   | Daten verarbeiten -> Perspektive data.frame |
|**purrr:**   | Daten verarbeiten -> Perspektive list + vector |

Speziellere Pakete, die der selben Philosophie folgen: forcats, stringr, readxl, ...

**magrittr** dient dabei dazu, Funktionen systematisch aneinander zu reihen.

## tidyverse

\textcolor{black}{\textbf{1.}} neues R Skript \emph{\textasciitilde/expack/playground/sherds.R} zum Spielen anlegen

\textcolor{red}{\textbf{2.}} Skript der *.Rbuildignore* hinzufügen, um es vom Buildprozess des Pakets auszuklammern

```{r, eval=FALSE}
devtools::use_build_ignore("playground/sherds.R")
```

\textcolor{black}{\textbf{3.}} Bereits bekannten Code kopieren

```{r, eval=FALSE}
library(expack)
library(recexcavAAR)
library(magrittr)
library(tidyverse)

surf <- recexcavAAR::kriglist(
  list(nivellement1, nivellement2), lags = 2
  )
sherds_pos <- recexcavAAR::posdec(sherds[1:3], surf)
```

\textcolor{black}{\textbf{4.}} Let's play together: R.

## tidyverse -- Anzahl \textasciitilde\ Position

```{r, eval=FALSE}
sherds_main <- sherds %>%
  dplyr::mutate(pos = sherds_pos$pos) %>%
  dplyr::mutate(
    pos = replace(pos, pos == 0, "couche_rouge"),
    pos = replace(pos, pos == 1, "sec._loess"),
    pos = replace(pos, pos == 2, "plough_horizon")
  )
```

```{r, eval=FALSE}
stratigraphy <- c("plough_horizon", "sec._loess", "couche_rouge")
sherds_main$pos <- factor(sherds_main$pos, stratigraphy)

```

```{r, eval=FALSE}
sherds_main %>% ggplot() +
  geom_bar(aes(x = pos))
```

```{r, eval=FALSE}
sherds_main %>%
  dplyr::group_by(pos) %>%
  dplyr::summarise(count = n()) %>%
  dplyr::mutate(percentage = (count / sum(count) * 100) %>% round(0))
```

## tidyverse -- Anzahl \textasciitilde\ Dekoration

```{r, eval=FALSE}
sherds_main %>% ggplot() +
  geom_bar(aes(x = decoration)) +
  facet_grid(~pos) +
  theme(axis.text.x = element_text(
    angle = 30, hjust = 1, vjust = 1)
  )
```

```{r, eval=FALSE}
sherds_main <- sherds_main %>%
  tidyr::separate(
    decoration,
    into = c("deco", "deco_comment"), sep = ";",
    remove = FALSE
  )
```

```{r, eval=FALSE}
sherds_main %>% ggplot() +
  geom_bar(aes(x = deco)) +
  facet_grid(~pos)
```

## tidyverse -- Wandstärke \textasciitilde\ Durchmesser + Position

```{r, eval=FALSE}
g <- sherds_main %>% ggplot() +
  geom_point(aes(x = size, y = w_thick)) +
  facet_grid(~pos)
```

```{r, eval=FALSE}
models <- sherds_main %>%
  base::split(.$pos) %>%
  purrr::map(~lm(w_thick ~ size, data = .)) %>%
  purrr::map(~coef(.)) %>%
  as.data.frame %>% t %>% data.frame %>%
  dplyr::mutate(pos = factor(rownames(.), stratigraphy))
```

```{r, eval=FALSE}
g + geom_abline(
    data = models,
    aes(intercept = X.Intercept., slope = size)
  )
```



# Abschließende Gedanken

## Abschließende Gedanken

* \danger\  Das ist **kein** produktionsfertiges R-Paket. Wir haben einige essenzielle Aspekte ausgelassen: 
    * Dokumentation! (z.B. mit roxygen2)
    * Versionskontrolle (z.B. mit git)
    * korrekte Datenimplementierung
    * Tests
    * ...
* **Aber:** Wir haben einige coole Zusammenhänge berührt!
    * Paketentwicklung
    * 3D plots
    * RMarkdown
    * recexcavAAR
    * **tidyverse**
* recexcavAAR, mortAAR, quantAAR... **ISAAK** ist offen für externe Mitarbeit!

https://isaakiel.github.io/