---
title: "recexcavAAR and far beyond..."
subtitle: "Anregungen rund um R, Data Science und Archäologie"
author: "Clemens Schmid"
date: "17. Mai 2017"
fontsize: 9pt
header-includes:
   - \usepackage{menukeys}
   - \usepackage{fourier}
   - \usepackage{fontawesome}
   - \newcommand{\columnsbegin}{\begin{columns}}
   - \newcommand{\columnsend}{\end{columns}}
output:
  beamer_presentation:
    theme: "metropolis"
fig_caption: yes
---

## Tutorial

\columnsbegin
\column{0.4\textwidth}

\begin{figure}[h]
\centering
\includegraphics[scale=0.25]{images/tree.png}
\caption{Inhaltsbaum}
\end{figure}

\column{0.5\textwidth}

\begin{itemize}
  \item R Pakete
  \item 3D plots in R
  \item Reports
  \item recexcavAAR
  \item tidyverse
\end{itemize}

\begin{quote}
A step to help you slow down - put your fork/spoon down between bites and take a sip of water before picking them up for the next bite. 

-- reddit user \textbf{angelforhirex} im Thread "I want to learn how to eat smaller portions"
\end{quote}

\columnsend



# R Pakete

## R Pakete

R Development Core Team -- Writing R Extensions  
https://cran.r-project.org/doc/manuals/r-release/R-exts.pdf

**Hadley Wickham -- R packages**  
http://r-pkgs.had.co.nz/

\rule{\textwidth}{1pt}

> Packages are the fundamental units of reproducible R code. They include reusable **R functions**, the **documentation** that describes how to use them, and **sample data**.
>
> -- Hadley Wickham

## R Pakete

\columnsbegin
\column{0.5\textwidth}

\textbf{Windows ohne Rtools}

1. RStudio: Ein neues Projekt beliebigen Namens anlegen

2. Windows binaries für Paket expack herunterladen

https://github.com/nevrome/tutorial_cologne_may2017/tree/master/expack

3. RStudio: expack installieren (Packages > Install > Package Archive File)

\column{0.5\textwidth}

\textbf{Linux oder Windows mit Rtools}

1. Paket anlegen

```{r, eval=FALSE}
devtools::create("~/expack")
```

2. RStudio: In das entstandene Projekt wechseln

3. Beispieldaten schaufeln 

https://github.com/nevrome/tutorial_cologne_may2017/tree/master/data

\faFolderOpenO \emph{home/user/expack/data/}

4. Paket bauen und installieren: \newline \keys{\ctrl + \shift + B}

```{r, eval=FALSE}
devtools::build()
devtools::install()
library(expack)
```

\columnsend

## R Pakete

5. Fleischbeschau!

```{r, eval=FALSE}
help(package="expack")
```

6. Beispieldaten ansehen

```{r, eval=FALSE}
trench

```



# 3D plots in R

## 3D plots in R

JavaScript APIs: **plotly** & **rthreejs**  
https://plot.ly/r/#3d-charts & https://github.com/bwlewis/rthreejs

OpenGL API: **rgl**  
https://cran.r-project.org/web/packages/rgl/vignettes/rgl.html

\rule{\textwidth}{1pt}

Für echte 3D plots gibt es in R im Augenblick zwei Optionen:  
APIs zu JavaScript Rendering Bibliotheken und GPU APIs.

Nur **rgl** besitzt einen **großen Funktionsumfang**, ist wegen der direkten GPU Nutzung über OpenGL lokal **perfomant** und kann gleichermaßen automatisch embedded JavaScript für **Web-Anwendungen** generieren. 

\rule{\textwidth}{1pt}

JavaScript Visualisierung mit R:  
http://www.htmlwidgets.org/

## 3D plots in R

1. neues R-Skript \emph{home/user/expack/R/dreiD.R} anlegen

2. coole Funktion schreiben

```{r, eval=FALSE, size = "tiny"}
coolplot <- function(points_df, type = "p", ...){
  rgl::plot3d(
    points_df[, 1], points_df[, 2], points_df[, 3],
    type = type,
    xlab = "x", ylab = "y", zlab = "z",
    ...
  )
}
```

3. Namen der Funktion `coolplot` exportieren, indem man \emph{home/user/expack/NAMESPACE} editiert

```{}
export(coolplot)
```

## 3D plots in R

4. Paket \textbf{rgl} als Voraussetzung des Pakets definieren, indem man \emph{~/expack/DESCRIPTION} editiert

```{}
...
Description: What the package does (one paragraph).
Imports:
  rgl (>= 0.98.1)
Depends: R (>= 3.3.3)
...
```

5. Paket neu bauen: \keys{\ctrl + \shift + B}

6. Ausprobieren!

```{r, eval=FALSE}
coolplot(trench, type = "l")
coolplot(sherds, type = "p", add = TRUE)
```

## 3D plots in R

7. noch eine coole Funktion schreiben

```{r, eval=FALSE}
coolpicture <- function(image, position) {
  rgl::show2d( { par(mar = rep(0, 4))
                 plot( 0:1, 0:1, type = "n", ann = FALSE,
                       axes = FALSE, xaxs = "i", yaxs = "i" )
                 rasterImage(image, 0, 0, 1, 1)
                },
    x = position[, 1], y = position[, 2], z = position[, 3]
  )
}
```

8. Namen der neuen Funktion exportieren

```{}
export(coolpicture)
```

9. Bauen (\keys{\ctrl + \shift + B}) und Ausprobieren!

```{r, eval=FALSE}
coolplot(trench, type = "l")
coolpicture(Nprofile, Nprofile_corners)
```



# Reports 

## Reports

Markdown Cheatsheet  
http://commonmark.org/help/

Rmarkdown  
http://rmarkdown.rstudio.com/

## Reports

1. Eine neue Vignette anlegen und das Paket dafür vorbereiten

```{r, eval=FALSE}
devtools::use_vignette("recex")
```

2. Vignette testweise rendern: \keys{\ctrl + \shift + K} 

```{r, eval=FALSE}
rmarkdown::render("vignettes/recex.Rmd")
```

3. Inhalt abgesehen vom Header (zwischen `---`) löschen

4. Überschrift und Text anlegen (\danger\  Leerzeilen!)

```{}
# Space archaeology

The Kingdom of the Crystal Skull was a good movie.

> "RRRAARRWHHGWWR."
> -- Chewbacca in *The Empire Strikes Back*

![](https://goo.gl/XOF2ce)
```

## Reports

5. R code chunks anlegen: `` ```{r} `` ... `` ``` `` 

6. Chunks mit Leben füllen: Bibliotheken laden

`` ```{r} ``
```{r}
library(expack)
library(rgl)
```
`` ``` `` 

7. 2D Plot

`` ```{r} ``
```{r, eval = FALSE}
plot(sherds$x, sherds$z)
```
`` ``` `` 

## Reports

8. 3D Plot (und anschließend rendern: \keys{\ctrl + \shift + K})

`` ```{r, echo=FALSE, results="hide"} ``
```{r, eval=FALSE}
# avoid plotting in X11 window
open3d(useNULL = TRUE)
```
`` ``` `` 

`` ```{r} ``
```{r, eval=FALSE}
coolplot(trench, type = "l")
coolpicture(Nprofile, Nprofile_corners)
coolplot(sherds, type = "p", add = TRUE, col = "red", size = 10)
```
`` ``` `` 

`` ```{r, echo=FALSE} ``
```{r, eval=FALSE}
rglwidget()
```
`` ``` `` 


# recexcavAAR

## recexcavAAR

https://github.com/ISAAKiel/recexcavAAR

https://CRAN.R-project.org/package=recexcavAAR

> ...
>
> Title: 3D Reconstruction of Archaeological Excavations
>
> ...

\begin{figure}[h]
\centering
\includegraphics[scale=0.6]{images/history.png}
\caption{Timeline recexcavAAR}
\end{figure}

## recexcavAAR

1. Paket \textbf{recexcavAAR} als Voraussetzung des Pakets definieren

```{}
Imports:
  rgl (>= 0.98.1),
Suggests:
  recexcavAAR (>= 0.3.0)
```

2. Kriging und Positionsbestimmung in der Vignette hinzufügen

`` ```{r} ``
```{r, eval=FALSE}
surf <- recexcavAAR::kriglist(
  list(nivellement1, nivellement2), lags = 2
)
sherds_pos <- recexcavAAR::posdec(sherds[1:3], surf)
```
`` ``` ``

## recexcavAAR

3. 3D Plot (... und \keys{\ctrl + \shift + K})

`` ```{r} ``
```{r, eval=FALSE}
coolplot(trench, type = "l")
coolpicture(Nprofile, Nprofile_corners)
coolplot(
  sherds_pos, type = "p", add = TRUE, 
  col = sherds_pos$pos + 1, size = 10
)
coolplot(surf[[1]], type = "p", add = TRUE)
coolplot(surf[[2]], type = "p", add = TRUE)
```
`` ``` `` 

`` ```{r, echo=FALSE} ``
```{r, eval=FALSE}
rglwidget()
```
`` ``` `` 



# tidyverse

## tidyverse

Hadley Wickham -- R for Data Science  
http://r4ds.had.co.nz/

http://tidyverse.org/

\rule{\textwidth}{1pt}

Das tidyverse ist eine **Sammlung von auf einander angepassten Paketen** für **Datenverarbeitung** und **Modellierung**, die zum **digitalen Standardwerkzeug** eines Archäologen gehören sollte. 

|||
|---|---|
|**ggplot2:** | Daten visualisieren (plot 2.0) |
|**tibble:**  | Daten verwalten (data.frame 2.0 **?**) |
|**tidyr:**   | Datenlayout bereinigen |
|**readr:**   | Daten einlesen (read.table 2.0 **?**) |
|**dplyr:**   | Daten verarbeiten -> Perspektive data.frame |
|**purrr:**   | Daten verarbeiten -> Perspektive vektor |

Speziellere Pakete, die der selben Philosophie folgen: forcats, stringr, readxl, ...

**magrittr** dient dabei dazu, Funktionen systematisch aneinander zu reihen.

## tidyverse

1. neues R Skript \emph{home/user/expack/playground/sherds.R} zum Spielen anlegen

2. Skript der *.Rbuildignore* hinzufügen, um es vom Buildprozess des Pakets auszuklammern

```{r, eval=FALSE}
devtools::use_build_ignore("playground/sherds.R")
```

3. Bereits bekannten Code kopieren

```{r, eval=FALSE}
surf <- recexcavAAR::kriglist(
  list(nivellement1, nivellement2), lags = 2
)
sherds_pos <- recexcavAAR::posdec(sherds[1:3], surf)
```

# Abschließende Gedanken

## Abschließende Gedanken

* \danger\  Das ist **kein** produktionsfertiges R-Paket. Wir haben einige essenzielle Aspekte ausgelassen: 
    * Dokumentation! (z.B. mit roxygen2)
    * Versionskontrolle (z.B. mit git)
    * korrekte Datenimplementierung
    * Tests
    * ...
* Aber: Wir haben einige coole Zusammenhänge berührt!
    * Paketentwicklung
    * 3D plots
    * RMarkdown
    * recexcavAAR
    * **tidyverse**
* recexcavAAR, mortAAR, quantAAR... **ISAAK** ist offen für externe Mitarbeit!

https://isaakiel.github.io/